# é—®é¢˜ä¼˜åŒ–æ–¹æ¡ˆè®°å½•

## è®°å½•æ—¶é—´
**æ—¥æœŸ**: 2026-02-23
**è®°å½•äºº**: AI Assistant
**çŠ¶æ€**: æŒç»­æ›´æ–°ä¸­

---

## é—®é¢˜æ¸…å•

### é—®é¢˜ 1: McpManager ç±»å®ç°ä¸å®Œæ•´

#### é—®é¢˜æè¿°
`McpManager` ç±»åœ¨æµ‹è¯•æ–‡ä»¶ä¸­è¢«å¼•ç”¨ï¼Œä½†åœ¨å®é™…ä»£ç ä¸­æœªå®Œæ•´å®ç°ï¼Œå¯¼è‡´æµ‹è¯•æ— æ³•é€šè¿‡ã€‚

#### æ ¹æœ¬åŸå› åˆ†æ (RCA)
1. **è®¾è®¡å…ˆè¡Œ**: è®¾è®¡æ–‡æ¡£ï¼ˆv0.2.0_design.mdï¼‰å·²å®Œæ•´æè¿°åŠŸèƒ½ï¼Œä½†ä»£ç å®ç°æ»å
2. **å¼€å‘æµç¨‹**: å¯èƒ½é‡‡ç”¨ TDD æ¨¡å¼ï¼Œä½†å®ç°æœªå®Œæˆ
3. **ä»£ç å®¡æŸ¥**: CODE_REVIEW_REPORT-2026-02-23.md å·²æŒ‡å‡ºæ­¤é—®é¢˜

#### å½±å“è¯„ä¼°
| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|----------|----------|------|
| **åŠŸèƒ½å¯ç”¨æ€§** | ğŸ”´ é«˜ | BotFlow åˆå§‹åŒ–æ—¶ä¼šæŠ¥é”™ |
| **æµ‹è¯•æ‰§è¡Œ** | ğŸ”´ é«˜ | ç›¸å…³æµ‹è¯•æ— æ³•é€šè¿‡ |
| **ä»£ç è´¨é‡** | ğŸŸ¡ ä¸­ | å½±å“é¡¹ç›®æ•´ä½“å®Œæ•´æ€§ |
| **ç”¨æˆ·ä½“éªŒ** | ğŸŸ¡ ä¸­ | MCP åŠŸèƒ½æ— æ³•ä½¿ç”¨ |

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ A: å®Œæ•´å®ç° McpManager ç±»**
```python
class McpManager:
    """MCP ç®¡ç†å™¨ - å®Œæ•´å®ç°"""
    
    def __init__(self, config_path: str = None):
        self.config_path = config_path
        self.client = None
        self._tools = []
        self._servers = {}
        
        if config_path:
            self._load_config()
    
    def _load_config(self):
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        import json
        with open(self.config_path, 'r', encoding='utf-8') as f:
            config = json.load(f)
            self._servers = config.get('servers', {})
    
    async def get_tools(self):
        """è·å–å·¥å…·åˆ—è¡¨"""
        if not self.client:
            from langchain_mcp_adapters.client import MultiServerMCPClient
            self.client = MultiServerMCPClient(self._servers)
        self._tools = await self.client.get_tools()
        return self._tools
    
    async def invoke(self, tool_name: str, **kwargs):
        """è°ƒç”¨å·¥å…·"""
        if not self.client:
            raise RuntimeError("MCP client not initialized")
        return await self.client.invoke(tool_name, **kwargs)
```

**æ–¹æ¡ˆ B: ä½¿ç”¨å­˜æ ¹å®ç°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰**
```python
class McpManager:
    """MCP ç®¡ç†å™¨ - å­˜æ ¹å®ç°"""
    
    def __init__(self, config_path: str = None):
        self.config_path = config_path
        self.client = None
    
    async def get_tools(self):
        """è¿”å›ç©ºå·¥å…·åˆ—è¡¨"""
        return []
    
    async def invoke(self, tool_name: str, **kwargs):
        """æŠ›å‡ºæœªå®ç°é”™è¯¯"""
        raise NotImplementedError("MCP manager not fully implemented")
```

**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆ Aï¼ˆå®Œæ•´å®ç°ï¼‰

#### å®æ–½æ—¶é—´è¡¨
| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|----------|--------|
| 1 | å®ç° McpManager æ ¸å¿ƒåŠŸèƒ½ | 2 å°æ—¶ | å¼€å‘äººå‘˜ |
| 2 | ç¼–å†™å•å…ƒæµ‹è¯• | 1 å°æ—¶ | å¼€å‘äººå‘˜ |
| 3 | é›†æˆæµ‹è¯• | 1 å°æ—¶ | å¼€å‘äººå‘˜ |
| 4 | ä»£ç å®¡æŸ¥ | 0.5 å°æ—¶ | å®¡æŸ¥äººå‘˜ |

#### éªŒè¯æŒ‡æ ‡
- [ ] `McpManager` ç±»å¯ä»¥æ­£å¸¸å®ä¾‹åŒ–
- [ ] `get_tools()` æ–¹æ³•è¿”å›æ­£ç¡®çš„å·¥å…·åˆ—è¡¨
- [ ] `invoke()` æ–¹æ³•å¯ä»¥æˆåŠŸè°ƒç”¨è¿œç¨‹å·¥å…·
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ç‡ 100%

#### é¢„é˜²æªæ–½
1. **ç±»å‹æ£€æŸ¥**: æ·»åŠ  mypy åˆ° CI/CD æµç¨‹
2. **ä»£ç å®¡æŸ¥**: å¼ºåˆ¶è¦æ±‚æ‰€æœ‰è¢«å¼•ç”¨çš„ç±»å¿…é¡»æœ‰å®ç°
3. **æµ‹è¯•é©±åŠ¨**: ç¡®ä¿æµ‹è¯•ä¸å®ç°åŒæ­¥å®Œæˆ

---

### é—®é¢˜ 2: LangChainMCPToolManager ç±»å®ç°ä¸å®Œæ•´

#### é—®é¢˜æè¿°
`LangChainMCPToolManager` ç±»ä¸ `McpManager` ç±»ä¼¼ï¼Œåœ¨æµ‹è¯•ä¸­è¢«å¼•ç”¨ä½†å®ç°ä¸å®Œæ•´ã€‚

#### æ ¹æœ¬åŸå› åˆ†æ (RCA)
ä¸é—®é¢˜ 1 ç›¸åŒï¼šè®¾è®¡å…ˆè¡Œï¼Œå®ç°æ»åã€‚

#### å½±å“è¯„ä¼°
| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|----------|----------|------|
| **åŠŸèƒ½å¯ç”¨æ€§** | ğŸ”´ é«˜ | BotFlow åˆå§‹åŒ–æ—¶ä¼šæŠ¥é”™ |
| **LangChain é›†æˆ** | ğŸ”´ é«˜ | æ— æ³•ä¸ LangChain å·¥å…·é“¾é›†æˆ |

#### ä¼˜åŒ–æ–¹æ¡ˆ

**å®Œæ•´å®ç°**:
```python
class LangChainMCPToolManager:
    """LangChain MCP å·¥å…·ç®¡ç†å™¨"""
    
    def __init__(self, config_path: str):
        self.mcp_manager = McpManager(config_path)
        self._langchain_tools = []
    
    def get_tools(self):
        """è·å– LangChain æ ¼å¼çš„å·¥å…·åˆ—è¡¨"""
        import asyncio
        mcp_tools = asyncio.run(self.mcp_manager.get_tools())
        
        # è½¬æ¢ä¸º LangChain å·¥å…·æ ¼å¼
        self._langchain_tools = []
        for tool in mcp_tools:
            from langchain.tools import Tool
            langchain_tool = Tool(
                name=tool.name,
                description=tool.description,
                func=lambda **kwargs: asyncio.run(
                    self.mcp_manager.invoke(tool.name, **kwargs)
                )
            )
            self._langchain_tools.append(langchain_tool)
        
        return self._langchain_tools
```

#### å®æ–½æ—¶é—´è¡¨
ä¸é—®é¢˜ 1 åŒæ­¥è¿›è¡Œ

#### éªŒè¯æŒ‡æ ‡
- [ ] `LangChainMCPToolManager` ç±»å¯ä»¥æ­£å¸¸å®ä¾‹åŒ–
- [ ] `get_tools()` è¿”å› LangChain æ ¼å¼çš„å·¥å…·åˆ—è¡¨
- [ ] å·¥å…·å¯ä»¥æˆåŠŸç»‘å®šåˆ° LangChain ä»£ç†

---

### é—®é¢˜ 3: é…ç½®æ¨¡å‹ç¼ºå°‘ mcp_servers é…ç½®é¡¹

#### é—®é¢˜æè¿°
`botflow/core.py` ä¸­å¼•ç”¨äº† `config.mcp_servers`ï¼Œä½†é…ç½®æ¨¡å‹ä¸­æœªå®šä¹‰è¯¥å±æ€§ã€‚

#### æ ¹æœ¬åŸå› åˆ†æ (RCA)
1. **é…ç½®æ¨¡å‹æœªæ›´æ–°**: æ–°å¢åŠŸèƒ½æ—¶æœªåŒæ­¥æ›´æ–°é…ç½®æ¨¡å‹
2. **ç±»å‹æ£€æŸ¥ç¼ºå¤±**: ç¼ºå°‘é™æ€ç±»å‹æ£€æŸ¥å¯¼è‡´é—®é¢˜æœªè¢«å‘ç°

#### å½±å“è¯„ä¼°
| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|----------|----------|------|
| **é…ç½®åŠ è½½** | ğŸ”´ é«˜ | é…ç½®æ–‡ä»¶æ— æ³•æ­£ç¡®è§£æ |
| **åŠŸèƒ½å¯ç”¨** | ğŸŸ¡ ä¸­ | MCP åŠŸèƒ½æ— æ³•é€šè¿‡é…ç½®å¯ç”¨ |

#### ä¼˜åŒ–æ–¹æ¡ˆ

**é…ç½®æ¨¡å‹æ›´æ–°**:
```python
from pydantic import BaseModel, Field

class McpServersConfig(BaseModel):
    """MCP æœåŠ¡å™¨é…ç½®"""
    enabled: bool = False
    mcp_config_path: str = "config/mcp.json"

class OpenbotConfig(BaseModel):
    """OpenBot ä¸»é…ç½®"""
    # ... å…¶ä»–é…ç½®é¡¹
    
    mcp_servers: McpServersConfig = Field(
        default_factory=McpServersConfig
    )
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹** (`config/mcp.json`):
```json
{
  "mcpServers": {
    "GitHub": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_PERSONAL_ACCESS_TOKEN": ""
      }
    }
  }
}
```

#### å®æ–½æ—¶é—´è¡¨
| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|----------|--------|
| 1 | æ›´æ–°é…ç½®æ¨¡å‹ | 0.5 å°æ—¶ | å¼€å‘äººå‘˜ |
| 2 | æ·»åŠ é…ç½®éªŒè¯ | 0.5 å°æ—¶ | å¼€å‘äººå‘˜ |
| 3 | æ›´æ–°æ–‡æ¡£ | 0.5 å°æ—¶ | å¼€å‘äººå‘˜ |

#### éªŒè¯æŒ‡æ ‡
- [ ] é…ç½®æ¨¡å‹åŒ…å« `mcp_servers` å±æ€§
- [ ] é…ç½®æ–‡ä»¶å¯ä»¥æ­£ç¡®è§£æ
- [ ] é…ç½®éªŒè¯é€šè¿‡

---

### é—®é¢˜ 4: æ–‡æ¡£ä¸å®ç°ä¸åŒæ­¥

#### é—®é¢˜æè¿°
è®¾è®¡æ–‡æ¡£ï¼ˆv0.2.0_design.mdï¼‰æè¿°äº†å®Œæ•´åŠŸèƒ½ï¼Œä½†ä»£ç å®ç°æ»åã€‚

#### æ ¹æœ¬åŸå› åˆ†æ (RCA)
1. **å¼€å‘æµç¨‹**: é‡‡ç”¨è®¾è®¡å…ˆè¡Œæ¨¡å¼ï¼Œä½†å®ç°è·Ÿè¿›ä¸åŠæ—¶
2. **é¡¹ç›®ç®¡ç†**: ç¼ºå°‘ä»»åŠ¡è·Ÿè¸ªæœºåˆ¶
3. **èµ„æºåˆ†é…**: å¯èƒ½å—é™äºå¼€å‘èµ„æº

#### å½±å“è¯„ä¼°
| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|----------|----------|------|
| **å›¢é˜Ÿåä½œ** | ğŸŸ¡ ä¸­ | æ–°æˆå‘˜å¯èƒ½å›°æƒ‘äºæ–‡æ¡£ä¸ä»£ç å·®å¼‚ |
| **é¡¹ç›®è¿›åº¦** | ğŸŸ¡ ä¸­ | å½±å“æ•´ä½“å¼€å‘è¿›åº¦æŠŠæ§ |

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ A: æ–‡æ¡£ç‰ˆæœ¬æ§åˆ¶**
- åœ¨æ–‡æ¡£ä¸­æ˜ç¡®æ ‡æ³¨å®ç°çŠ¶æ€
- æ·»åŠ  "å®ç°è¿›åº¦" ç« èŠ‚

**æ–¹æ¡ˆ B: ä»»åŠ¡è·Ÿè¸ªç³»ç»Ÿ**
- ä½¿ç”¨ GitHub Issues æˆ–ç±»ä¼¼å·¥å…·è·Ÿè¸ªå®ç°ä»»åŠ¡
- å°†è®¾è®¡æ–‡æ¡£ä¸­çš„åŠŸèƒ½ç‚¹è½¬åŒ–ä¸ºå…·ä½“ä»»åŠ¡

**æ–¹æ¡ˆ C: æ–‡æ¡£ä¸ä»£ç åŒæ­¥æ£€æŸ¥**
- å®šæœŸå®¡æŸ¥æ–‡æ¡£ä¸ä»£ç çš„ä¸€è‡´æ€§
- åœ¨ä»£ç å®¡æŸ¥ä¸­æ£€æŸ¥æ–‡æ¡£æ›´æ–°

**æ¨èæ–¹æ¡ˆ**: ç»„åˆä½¿ç”¨æ–¹æ¡ˆ A + B

#### å®æ–½æ—¶é—´è¡¨
| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|----------|--------|
| 1 | æ›´æ–°è®¾è®¡æ–‡æ¡£ï¼Œæ·»åŠ å®ç°çŠ¶æ€ | 1 å°æ—¶ | å¼€å‘äººå‘˜ |
| 2 | åˆ›å»º GitHub Issues è·Ÿè¸ªä»»åŠ¡ | 0.5 å°æ—¶ | é¡¹ç›®ç»ç† |
| 3 | å»ºç«‹å®šæœŸå®¡æŸ¥æœºåˆ¶ | 0.5 å°æ—¶ | å›¢é˜Ÿè´Ÿè´£äºº |

---

## é—®é¢˜ä¼˜å…ˆçº§çŸ©é˜µ

| é—®é¢˜ | ç´§æ€¥ç¨‹åº¦ | é‡è¦ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|----------|----------|--------|------|
| McpManager ç±»å®ç°ä¸å®Œæ•´ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | P0 | å¾…åŠ |
| LangChainMCPToolManager ç±»å®ç°ä¸å®Œæ•´ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | P0 | å¾…åŠ |
| é…ç½®æ¨¡å‹ç¼ºå°‘ mcp_servers | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | P1 | å¾…åŠ |
| æ–‡æ¡£ä¸å®ç°ä¸åŒæ­¥ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | P2 | å¾…åŠ |

---

## å®æ–½è·¯çº¿å›¾

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³æ‰§è¡Œï¼‰
- [ ] å®ç° McpManager ç±»
- [ ] å®ç° LangChainMCPToolManager ç±»
- [ ] ä¿®å¤ç›¸å…³æµ‹è¯•

### ç¬¬äºŒé˜¶æ®µï¼ˆæœ¬å‘¨å†…ï¼‰
- [ ] æ›´æ–°é…ç½®æ¨¡å‹ï¼Œæ·»åŠ  mcp_servers
- [ ] æ·»åŠ é…ç½®éªŒè¯
- [ ] æ›´æ–°è®¾è®¡æ–‡æ¡£å®ç°çŠ¶æ€

### ç¬¬ä¸‰é˜¶æ®µï¼ˆæœ¬æœˆå†…ï¼‰
- [ ] å»ºç«‹æ–‡æ¡£åŒæ­¥æ£€æŸ¥æœºåˆ¶
- [ ] æ·»åŠ ç±»å‹æ£€æŸ¥åˆ° CI/CD
- [ ] å®Œå–„ MCP åŠŸèƒ½æ–‡æ¡£

---

## æ•ˆæœè¯„ä¼°æœºåˆ¶

### çŸ­æœŸè¯„ä¼°ï¼ˆ1å‘¨å†…ï¼‰
- æ‰€æœ‰ç›¸å…³æµ‹è¯•é€šè¿‡
- MCP åŠŸèƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨
- é…ç½®æ–‡ä»¶æ­£ç¡®è§£æ

### ä¸­æœŸè¯„ä¼°ï¼ˆ1ä¸ªæœˆå†…ï¼‰
- æ–‡æ¡£ä¸ä»£ç åŒæ­¥ç‡ > 90%
- ç±»å‹æ£€æŸ¥æ— é”™è¯¯
- ä»£ç å®¡æŸ¥é€šè¿‡ç‡æå‡

### é•¿æœŸè¯„ä¼°ï¼ˆ3ä¸ªæœˆå†…ï¼‰
- ç±»ä¼¼é—®é¢˜ä¸å†å‘ç”Ÿ
- å¼€å‘æ•ˆç‡æå‡
- å›¢é˜Ÿåä½œé¡ºç•…

---

## é™„å½•

### ç›¸å…³æ–‡ä»¶
- `src/openbot/agents/tools.py` - MCP å·¥å…·ç®¡ç†å®ç°
- `src/openbot/botflow/core.py` - BotFlow æ ¸å¿ƒå®ç°
- `src/openbot/config.py` - é…ç½®æ¨¡å‹å®šä¹‰
- `docs/design/v0.2.0_design.md` - è®¾è®¡æ–‡æ¡£
- `docs/CODE_REVIEW_REPORT-2026-02-23.md` - ä»£ç å®¡æŸ¥æŠ¥å‘Š

### ç›¸å…³æµ‹è¯•
- `tests/unit/test_mcp_functionality.py`
- `tests/unit/test_mcp_communication.py`
- `tests/integration/test_mcp_integration.py`

### ä¿®æ”¹å†å²
| æ—¥æœŸ | ä¿®æ”¹å†…å®¹ | ä¿®æ”¹äºº |
|------|----------|--------|
| 2026-02-23 | åˆå§‹åˆ›å»ºé—®é¢˜ä¼˜åŒ–æ–¹æ¡ˆ | AI Assistant |
