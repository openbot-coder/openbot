# BotFlow 设计文档

## 1. 项目概述

**项目名称**: BotFlow  
**项目类型**: 基于 FastAPI 的 AI Bot 框架  
**核心功能**: 统一的消息处理系统，支持 WebSocket、微信公众号通道，内置消息队列和定时任务  
**目标用户**: 单用户（个人使用）

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│  Channels (外部)                                                │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │
│  │  WebSocket │   │   WeChat    │   │  Scheduler  │          │
│  │  Channel   │   │   Channel   │   │             │          │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘          │
│         │                 │                 │                   │
│         └─────────────────┼─────────────────┘                   │
│                           ▼                                     │
│              ┌────────────────────────┐                        │
│              │      FastBotFlow        │                        │
│              │  • 消息路由转发         │                        │
│              │  • 消息持久化 (SQLite)  │                        │
│              │  • 消息队列管理         │                        │
│              └────────────┬─────────────┘                        │
│                           │                                      │
│                           ▼                                      │
│              ┌────────────────────────┐                        │
│              │    Message Queue       │                        │
│              │  (优先队列 + Workers)  │                        │
│              └────────────┬─────────────┘                        │
│                           │                                      │
│                           ▼                                      │
│              ┌────────────────────────┐                        │
│              │  OpenBotExecutor (Agent)│                        │
│              └────────────┬─────────────┘                        │
│                           │                                      │
│                           ▼ (返回)                               │
│              ┌────────────────────────┐                        │
│              │      FastBotFlow        │                        │
│              │  • 路由到对应 Channel  │                        │
│              └────────────┬─────────────┘                        │
│                           │                                      │
│         ┌─────────────────┼─────────────────┐                   │
│         ▼                 ▼                 ▼                   │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │
│  │  WebSocket │   │   WeChat    │   │             │          │
│  │   返回     │   │   返回      │   │   返回     │          │
│  └─────────────┘   └─────────────┘   └─────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 组件职责

| 组件 | 职责 |
|------|------|
| **WebSocket Channel** | 处理 WebSocket 连接，收发消息 |
| **WeChat Channel** | 处理微信公众号验证和消息收发 |
| **Scheduler** | 定时任务：系统任务、脚本执行、主动消息 |
| **FastBotFlow** | 核心中枢：路由、持久化、队列管理 |
| **Message Queue** | 消息缓冲，优先队列，分发给 Workers |
| **OpenBotExecutor** | AI 代理，处理消息并生成响应 |
| **Database** | SQLite 持久化存储 |

## 3. 数据模型

### 3.1 数据库表

**messages 表**
| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 消息 ID (UUID) |
| content | TEXT | 消息内容 |
| role | TEXT | user / assistant / system |
| channel_type | TEXT | 来源通道：websocket / wechat |
| token_count | INTEGER | token 用量 |
| process_time_ms | INTEGER | 处理时间（毫秒） |
| created_at | TEXT | 创建时间 (ISO8601) |

**sessions 表** (预留，当前单用户单会话)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 会话 ID |
| created_at | TEXT | 创建时间 |

### 3.2 消息队列

**消息优先级**
- HIGH (0): 系统消息、紧急任务
- NORMAL (10): 用户消息
- LOW (20): 后台任务

**消息结构**
```python
{
    "id": "uuid",
    "priority": 0-20,
    "content": "消息内容",
    "channel_type": "websocket|wechat",
    "reply_to": "原消息ID",  # 用于路由返回
    "metadata": {}
}
```

## 4. 通道设计

### 4.1 WebSocket Channel

- **连接管理**: 支持多连接，广播消息
- **消息格式**: JSON
- **流式响应**: 支持 chunks 推送

### 4.2 WeChat Channel

- **验证**: Token 签名验证
- **消息解析**: XML → JSON
- **被动回复**: 用户发消息后自动回复
- **主动推送**: 通过客服消息接口推送

## 5. 定时任务设计

### 5.1 任务类型

1. **系统任务**: 清理过期数据、统计等
2. **脚本任务**: 执行 agents 编写的脚本
3. **主动消息**: 大模型生成消息，通过指定通道发送

### 5.2 调度方式

- **间隔任务**: 每 N 秒/分/小时执行
- **Cron 任务**: 特定时间执行
- **一次性任务**: 指定时间执行一次

## 6. API 设计

### 6.1 WebSocket

```
WS /ws/chat
```

### 6.2 WeChat

```
GET  /wechat (验证)
POST /wechat (消息回调)
```

## 7. 依赖

```toml
dependencies = [
    "fastapi>=0.109.0",
    "uvicorn[standard]>=0.27.0",
    "aiosqlite>=0.20.0",
    "aiohttp>=3.9.0",
]
```

## 8. 验收标准

- [ ] WebSocket 通道可收发消息
- [ ] WeChat 通道可验证和收发消息
- [ ] 消息持久化到 SQLite
- [ ] 记录 token 用量和处理时间
- [ ] 定时任务可执行
- [ ] 大模型响应正确路由到对应通道
