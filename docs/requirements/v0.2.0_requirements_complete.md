# OpenBot v0.2.0 需求分析文档

## 1. 项目概述

### 1.1 项目背景
OpenBot 是一个基于 LangChain 和 DeepAgents 的智能代理框架，旨在提供灵活、可扩展的 AI 助手解决方案。v0.2.0 版本重点优化了启动性能、增强了工具调用稳定性，并提供了更友好的命令行交互界面。

### 1.2 项目目标
- 提供快速的启动体验（懒加载机制）
- 支持多种 LLM 模型的灵活切换
- 集成 MCP 工具生态
- 提供稳定的工具调用重试机制
- 提供友好的交互式 CLI 界面

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| **Agent** | 智能代理，能够理解和执行用户指令的 AI 系统 |
| **MCP** | Model Context Protocol，模型上下文协议，用于工具集成 |
| **LLM** | Large Language Model，大型语言模型 |
| **CLI** | Command Line Interface，命令行界面 |
| **懒加载** | 延迟初始化策略，按需加载资源以加快启动速度 |
| **流式响应** | 逐步返回 AI 生成内容，提升用户体验 |

---

## 2. 功能需求

### 2.1 智能代理核心 (agents/core.py)

#### FR-001: 支持多模型配置和切换
**优先级:** 高

**描述:**
系统应支持配置多个 LLM 模型，并能够在运行时根据策略切换使用的模型。

**详细说明:**
- 支持在配置文件中定义多个模型
- 支持通过名称指定使用特定模型
- 支持 "auto" 策略随机选择非默认模型
- 模型配置包括：提供商、模型名称、API 密钥、温度等参数

**验收标准:**
- [ ] 可以配置至少 2 个不同的模型
- [ ] 可以通过名称获取指定模型
- [ ] "auto" 策略能够随机选择模型
- [ ] 模型切换不影响对话上下文

**代码引用:**
- `OpenBotExecutor.__init__()` - 初始化模型管理器
- `ModelManager.get_model()` - 获取模型（支持 auto 策略）

---

#### FR-002: 支持懒加载初始化
**优先级:** 高

**描述:**
系统应采用懒加载策略，延迟初始化耗时资源，以实现快速启动。

**详细说明:**
- 构造函数只进行轻量级初始化
- 模型、工具等资源在首次使用时初始化
- 支持后台异步初始化
- 提供初始化状态查询接口

**验收标准:**
- [ ] CLI 启动时间 < 1 秒
- [ ] 首次对话时自动完成初始化
- [ ] 提供 `is_initialized` 状态查询
- [ ] 支持 `ensure_initialized()` 强制初始化

**代码引用:**
- `OpenBotExecutor._initialized` - 初始化状态标志
- `OpenBotExecutor.init_agent()` - 异步初始化方法
- `OpenBotExecutor.ensure_initialized()` - 确保初始化方法

---

#### FR-003: 支持工具调用重试机制
**优先级:** 高

**描述:**
系统应在工具调用失败时自动重试，提高稳定性和可靠性。

**详细说明:**
- 支持配置最大重试次数（默认 3 次）
- 采用指数退避策略（1s → 2s → 4s）
- 只对可重试错误进行重试（网络、超时等）
- 重试过程对用户透明

**验收标准:**
- [ ] 工具调用失败时自动重试
- [ ] 重试 3 次后仍失败才报错
- [ ] 每次重试间隔递增
- [ ] 重试过程记录日志

**代码引用:**
- `OpenBotExecutor.achat()` - 包含重试逻辑

---

#### FR-004: 支持流式消息处理
**优先级:** 高

**描述:**
系统应支持流式处理 AI 响应，实时显示生成内容。

**详细说明:**
- 支持通过回调函数处理流式消息
- 区分不同类型的消息（模型回复、工具调用、中间步骤）
- 支持 Markdown 格式渲染
- 提供消息元数据（步骤类型、时间戳等）

**验收标准:**
- [ ] 能够实时显示 AI 生成的内容
- [ ] 区分显示模型回复和工具调用
- [ ] 支持 Markdown 格式
- [ ] 消息包含完整的元数据

**代码引用:**
- `OpenBotExecutor._handle_message_chunk()` - 消息块处理
- `AgentCLI.handle_streaming_message()` - 流式消息显示

---

### 2.2 工具管理 (agents/tools.py)

#### FR-005: 支持 MCP 工具加载
**优先级:** 高

**描述:**
系统应支持从 MCP 服务器加载工具，扩展 Agent 的能力。

**详细说明:**
- 支持从配置文件加载 MCP 服务器配置
- 支持从字典加载 MCP 配置
- 支持多个 MCP 服务器同时连接
- 支持异步获取工具列表

**验收标准:**
- [ ] 能够从配置文件加载 MCP 配置
- [ ] 能够连接多个 MCP 服务器
- [ ] 能够异步获取所有工具
- [ ] 支持 stdio 传输方式

**代码引用:**
- `ToolsManager.load_tools_from_config()` - 从配置加载
- `ToolsManager.load_tools_from_dict()` - 从字典加载
- `ToolsManager.get_tools()` - 异步获取工具

---

#### FR-006: 支持环境变量解析
**优先级:** 中

**描述:**
系统应支持在配置中使用环境变量，提高配置的灵活性。

**详细说明:**
- 支持 `${VAR_NAME}` 语法引用环境变量
- 支持嵌套字典中的环境变量
- 缺失的环境变量返回 None
- 非环境变量格式的字符串保持不变

**验收标准:**
- [ ] 能够解析 `${VAR_NAME}` 格式的环境变量
- [ ] 支持嵌套字典中的环境变量
- [ ] 缺失变量时返回 None 不报错
- [ ] 普通字符串不受影响

**代码引用:**
- `ToolsManager._resolve_env_vars()` - 环境变量解析

---

#### FR-007: 支持内置工具（时间、文件、命令）
**优先级:** 中

**描述:**
系统应提供常用的内置工具，无需外部 MCP 服务器即可使用。

**详细说明:**
- `get_current_time()` - 获取当前时间
- `remove_file()` - 删除文件到回收站
- `run_bash_command()` - 执行 Bash 命令
- 内置工具与 MCP 工具统一管理

**验收标准:**
- [ ] `get_current_time()` 返回正确格式的时间
- [ ] `remove_file()` 将文件移动到回收站
- [ ] `run_bash_command()` 正确执行命令并返回输出
- [ ] 内置工具可被 Agent 调用

**代码引用:**
- `get_current_time()` - 时间工具
- `remove_file()` - 文件删除工具
- `run_bash_command()` - 命令执行工具

---

### 2.3 模型管理 (agents/models.py)

#### FR-008: 支持多模型配置
**优先级:** 高

**描述:**
系统应支持管理多个 LLM 模型配置，便于灵活切换。

**详细说明:**
- 支持添加多个命名模型
- 支持 ModelConfig 配置对象
- 支持直接传入 BaseChatModel 实例
- 第一个添加的模型自动设为默认

**验收标准:**
- [ ] 可以添加多个命名模型
- [ ] 支持通过 ModelConfig 添加
- [ ] 支持直接传入模型实例
- [ ] 可以列出所有已添加的模型

**代码引用:**
- `ModelManager.add_model()` - 添加模型
- `ModelManager.list_models()` - 列出模型

---

#### FR-009: 支持模型自动切换
**优先级:** 中

**描述:**
系统应支持自动策略，随机选择非默认模型，实现负载均衡。

**详细说明:**
- 支持 "auto" 策略标识
- 随机选择非默认模型
- 排除当前默认模型
- 需要至少 2 个模型才有效

**验收标准:**
- [ ] "auto" 策略能够随机选择模型
- [ ] 不会选择当前默认模型
- [ ] 只有一个模型时返回默认模型
- [ ] 随机选择均匀分布

**代码引用:**
- `ModelManager.get_model()` - auto 策略实现

---

### 2.4 控制台界面 (agents/cli.py)

#### FR-010: 支持交互式对话
**优先级:** 高

**描述:**
系统应提供交互式命令行界面，支持用户与 Agent 实时对话。

**详细说明:**
- 支持多轮对话
- 支持命令历史记录
- 支持自动补全
- 实时显示 AI 响应

**验收标准:**
- [ ] 可以连续进行多轮对话
- [ ] 支持上下箭头浏览历史
- [ ] 支持 Tab 自动补全
- [ ] 响应实时显示不卡顿

**代码引用:**
- `AgentCLI.run()` - 主循环
- `AgentCLI.chat()` - 对话处理

---

#### FR-011: 支持命令行命令
**优先级:** 中

**描述:**
系统应支持特殊命令（以 / 开头），提供辅助功能。

**详细说明:**
- `/help` - 显示帮助信息
- `/exit` 或 `/quit` - 退出程序
- `/clear` - 清屏
- `/models` - 显示已加载模型
- `/tools` - 显示可用工具
- `/status` - 显示系统状态

**验收标准:**
- [ ] `/help` 显示所有可用命令
- [ ] `/exit` 正常退出程序
- [ ] `/clear` 清除屏幕内容
- [ ] `/models` 显示模型列表
- [ ] `/tools` 显示工具列表
- [ ] `/status` 显示系统状态

**代码引用:**
- `AgentCLI.run()` - 命令处理逻辑

---

#### FR-012: 支持后台初始化
**优先级:** 高

**描述:**
系统应在启动时后台异步初始化 Agent，不阻塞用户输入。

**详细说明:**
- CLI 启动后立即接受输入
- 后台异步初始化 Agent
- 首次对话时如未初始化完成则等待
- 显示初始化状态提示

**验收标准:**
- [ ] CLI 启动后立即显示提示符
- [ ] 后台自动初始化 Agent
- [ ] 首次对话自动等待初始化完成
- [ ] 显示初始化进度提示

**代码引用:**
- `AgentCLI._background_init()` - 后台初始化
- `AgentCLI._ensure_agent_ready()` - 确保就绪

---

## 3. 非功能需求

### 3.1 性能需求

#### NFR-001: 启动时间
**优先级:** 高

**描述:** CLI 启动时间应小于 1 秒。

**指标:** 从执行命令到显示提示符 < 1s

#### NFR-002: 响应时间
**优先级:** 高

**描述:** 用户输入后，系统应在 100ms 内开始响应。

**指标:** 输入到首次输出延迟 < 100ms

#### NFR-003: 内存使用
**优先级:** 中

**描述:** 系统内存使用应控制在合理范围内。

**指标:** 空闲状态内存 < 500MB

### 3.2 可靠性需求

#### NFR-004: 工具调用成功率
**优先级:** 高

**描述:** 在重试机制支持下，工具调用成功率应达到 99%以上。

**指标:** 工具调用成功率 >= 99%

#### NFR-005: 异常处理
**优先级:** 高

**描述:** 系统应优雅处理各种异常情况，不崩溃。

**要求:**
- 所有异常被捕获并记录
- 用户收到友好的错误提示
- 系统可以从错误中恢复

#### NFR-006: 数据持久化
**优先级:** 中

**描述:** 对话历史应正确保存，不丢失。

**要求:** 系统崩溃后对话历史可恢复

### 3.3 可用性需求

#### NFR-007: 命令帮助
**优先级:** 中

**描述:** 用户可以随时查看命令帮助。

**要求:** `/help` 命令显示所有可用命令及说明

#### NFR-008: 错误提示
**优先级:** 高

**描述:** 错误信息应清晰、友好、可操作。

**要求:**
- 错误信息使用中文
- 包含错误原因
- 提供解决建议

#### NFR-009: 日志记录
**优先级:** 中

**描述:** 系统应记录详细日志，便于问题排查。

**要求:**
- 日志写入文件，不污染控制台
- 包含时间戳、日志级别、消息
- 支持 DEBUG/INFO/WARNING/ERROR 级别

### 3.4 可维护性需求

#### NFR-010: 代码注释
**优先级:** 中

**描述:** 代码应包含清晰的注释。

**要求:**
- 所有公共方法有 docstring
- 复杂逻辑有 inline 注释
- 注释使用中文

#### NFR-011: 测试覆盖率
**优先级:** 高

**描述:** 代码应有充分的测试覆盖。

**指标:** 单元测试覆盖率 >= 90%

#### NFR-012: 配置分离
**优先级:** 中

**描述:** 配置应与代码分离，支持外部配置。

**要求:**
- 支持 JSON 配置文件
- 支持环境变量
- 配置热加载

### 3.5 安全需求

#### NFR-013: API 密钥保护
**优先级:** 高

**描述:** API 密钥等敏感信息应安全存储。

**要求:**
- 支持环境变量传入密钥
- 密钥不在代码中硬编码
- 日志中不输出密钥

#### NFR-014: 命令执行安全
**优先级:** 高

**描述:** Bash 命令执行应限制风险。

**要求:**
- 不执行危险命令（rm -rf / 等）
- 命令执行有超时限制
- 错误命令不导致系统崩溃

### 3.6 兼容性需求

#### NFR-015: Python 版本
**优先级:** 高

**描述:** 系统应支持 Python 3.9+。

**要求:** 在 Python 3.9、3.10、3.11、3.12 上测试通过

#### NFR-016: 操作系统
**优先级:** 中

**描述:** 系统应支持 Windows、macOS、Linux。

**要求:** 在主流操作系统上运行正常

### 3.7 扩展性需求

#### NFR-017: MCP 工具扩展
**优先级:** 中

**描述:** 系统应易于添加新的 MCP 工具。

**要求:** 通过配置文件即可添加新工具，无需修改代码

#### NFR-018: 模型提供商扩展
**优先级:** 中

**描述:** 系统应易于支持新的 LLM 提供商。

**要求:** 通过配置即可添加新提供商，无需修改核心代码

---

## 4. 接口需求

### 4.1 外部接口

#### 4.1.1 CLI 接口

**启动命令:**
```bash
python -m openbot.agents.cli
```

**环境变量:**
- `OPENBOT_CONFIG_PATH` - 配置文件路径（默认: config/config.json）
- `OPENBOT_LOG_LEVEL` - 日志级别（默认: WARNING）

**交互命令:**
- `/help` - 显示帮助
- `/exit`, `/quit` - 退出
- `/clear` - 清屏
- `/models` - 显示模型
- `/tools` - 显示工具
- `/status` - 显示状态

#### 4.1.2 配置文件接口

**配置格式:**
```json
{
  "model_configs": {
    "model-name": {
      "model_provider": "openai",
      "model": "gpt-4o",
      "api_key": "${OPENAI_API_KEY}",
      "temperature": 0.7,
      "base_url": "https://api.openai.com/v1"
    }
  },
  "agent_config": {
    "workspace": "./workspace",
    "mcp_config": "config/mcp.json",
    "default_model": "model-name",
    "debug": false,
    "memory": true,
    "skills": []
  }
}
```

### 4.2 内部接口

#### 4.2.1 OpenBotExecutor 接口

```python
class OpenBotExecutor:
    def __init__(self, model_configs: Dict[str, Any], agent_config: AgentConfig)
    async def init_agent(self) -> None
    async def ensure_initialized(self) -> None
    def chat(self, message: ChatMessage, streaming_callback: Callable | None = None) -> List[ChatMessage]
    async def achat(self, message: ChatMessage, streaming_callback: Callable | None = None, max_retries: int = 3) -> List[ChatMessage]
    
    @property
    def is_initialized(self) -> bool
    @property
    def is_initializing(self) -> bool
    @property
    def model_manager(self) -> ModelManager
    @property
    def agent(self) -> Any
```

#### 4.2.2 ToolsManager 接口

```python
class ToolsManager:
    def __init__(self)
    def load_tools_from_config(self, config_path: str) -> Tuple[bool, List[BaseTool]]
    def load_tools_from_dict(self, mcp_configs: dict) -> bool
    async def get_tools(self) -> List[BaseTool]
```

#### 4.2.3 ModelManager 接口

```python
class ModelManager:
    def __init__(self, strategy: Literal["auto", "manual"] = "auto", default_model: str = "")
    def add_model(self, name: str, model: Union[BaseChatModel, ModelConfig], is_default: bool = False)
    def get_model(self, name: str = None) -> BaseChatModel
    def list_models(self) -> Dict[str, Any]
```

---

## 5. 数据需求

### 5.1 数据存储

#### 5.1.1 配置文件

**位置:** `config/config.json`

**内容:** 模型配置、Agent 配置

**格式:** JSON

#### 5.1.2 MCP 配置

**位置:** `config/mcp.json`

**内容:** MCP 服务器配置

**格式:** JSON

#### 5.1.3 日志文件

**位置:** `logs/openbot_YYYYMMDD.log`

**内容:** 运行日志

**格式:** 文本

**保留策略:** 7 天滚动

#### 5.1.4 工作区

**位置:** 配置的 workspace 目录

**内容:** 文件系统操作、记忆文件

### 5.2 数据流

```
用户输入 → CLI → OpenBotExecutor → Agent → LLM
                     ↓
                ToolsManager → MCP 工具
                     ↓
                流式响应 → CLI 显示
```

---

## 6. 验收标准

### 6.1 功能验收

| 需求 | 验收标准 | 测试方法 |
|------|----------|----------|
| FR-001 | 多模型配置正常 | 配置 2+ 模型，验证切换 |
| FR-002 | 启动 < 1s | 计时测试 |
| FR-003 | 重试 3 次 | 模拟失败，验证重试 |
| FR-004 | 流式显示 | 观察响应是否实时 |
| FR-005 | MCP 工具加载 | 配置 MCP，验证工具 |
| FR-006 | 环境变量解析 | 配置 ${VAR}，验证解析 |
| FR-007 | 内置工具可用 | 调用内置工具，验证结果 |
| FR-008 | 多模型管理 | 添加多个模型，验证列表 |
| FR-009 | auto 策略 | 调用 auto，验证随机性 |
| FR-010 | 交互式对话 | 进行多轮对话 |
| FR-011 | 命令支持 | 测试所有 / 命令 |
| FR-012 | 后台初始化 | 观察启动和首次对话 |

### 6.2 性能验收

| 指标 | 目标 | 测试方法 |
|------|------|----------|
| 启动时间 | < 1s | 多次启动取平均 |
| 响应时间 | < 100ms | 测量输入到输出延迟 |
| 内存使用 | < 500MB | 监控内存占用 |
| 工具成功率 | >= 99% | 统计调用成功率 |

### 6.3 质量验收

- [ ] 所有单元测试通过
- [ ] 代码覆盖率 >= 90%
- [ ] 无严重 Bug
- [ ] 文档完整
- [ ] 代码审查通过

---

## 7. 依赖关系

### 7.1 技术依赖

- Python 3.9+
- LangChain 0.3+
- LangGraph 0.2+
- DeepAgents
- Rich
- Prompt Toolkit

### 7.2 功能依赖

```
FR-002 (懒加载) → FR-012 (后台初始化)
FR-008 (模型配置) → FR-001 (多模型切换)
FR-005 (MCP 工具) → FR-003 (工具重试)
```

---

## 8. 附录

### 8.1 配置文件示例

**config/config.json:**
```json
{
  "model_configs": {
    "gpt4": {
      "model_provider": "openai",
      "model": "gpt-4o",
      "api_key": "${OPENAI_API_KEY}",
      "temperature": 0.7
    },
    "claude": {
      "model_provider": "anthropic",
      "model": "claude-3-opus-20240229",
      "api_key": "${ANTHROPIC_API_KEY}",
      "temperature": 0.7
    }
  },
  "agent_config": {
    "workspace": "./workspace",
    "mcp_config": "config/mcp.json",
    "default_model": "gpt4",
    "debug": false,
    "memory": true,
    "skills": []
  }
}
```

**config/mcp.json:**
```json
{
  "mcpServers": {
    "fetch": {
      "command": "uvx",
      "args": ["mcp-server-fetch"]
    }
  }
}
```

### 8.2 相关文档索引

- [详细设计文档](../design/v0.2.0_detailed_design.md)
- [API 文档](../api/README.md)
- [部署指南](../deployment/README.md)

---

**文档版本:** v0.2.0  
**最后更新:** 2026-02-24  
**作者:** OpenBot Team
